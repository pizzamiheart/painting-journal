<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - Art Stuff</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Art Stuff is a place to discover cool art from world-class museums. Browse, build a collection, and tell your friends.">
    <meta name="theme-color" content="#C5A55A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Art Stuff">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Inter:wght@400;500&display=swap" rel="stylesheet">

    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        :root {
            --color-gold: #C5A55A;
            --color-gold-light: #D4BC7C;
            --color-gold-dark: #9A7B3C;
            --color-surface: #F5F0EB;
            --color-text: #2D2926;
            --color-text-secondary: #5C5552;
            --color-text-muted: #8A8580;
            --color-terracotta: #C4785C;
            --color-terracotta-dark: #A8604A;
            --color-error: #B54A4A;
            --color-success: #4A7B5C;
            --font-serif: 'Cormorant Garamond', Georgia, serif;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: var(--font-sans);
            color: var(--color-text);
        }

        .auth-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 12px;
        }

        /* Golden frame border */
        .auth-page::before {
            content: '';
            position: absolute;
            inset: 12px;
            border: 5px solid var(--color-gold);
            box-shadow:
                inset 0 0 0 1px var(--color-gold-dark),
                inset 0 0 0 2px var(--color-gold-light),
                0 0 0 1px var(--color-gold-dark);
            pointer-events: none;
            z-index: 10;
        }

        /* Background painting */
        .auth-page__bg {
            position: absolute;
            inset: 0;
            background-image: url('/static/images/monet-bennecourt.jpg');
            background-size: cover;
            background-position: center;
            opacity: 0.45;
        }

        /* Gradient overlay for readability */
        .auth-page__overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(
                to bottom,
                rgba(232, 223, 212, 0.4) 0%,
                rgba(232, 223, 212, 0.5) 50%,
                rgba(232, 223, 212, 0.7) 100%
            );
        }

        .auth-card {
            position: relative;
            z-index: 5;
            width: 100%;
            max-width: 400px;
            padding: 2.5rem 2rem;
            background: linear-gradient(
                145deg,
                rgba(245, 240, 235, 0.97) 0%,
                rgba(240, 233, 223, 0.97) 50%,
                rgba(235, 226, 214, 0.97) 100%
            );
            border-radius: 4px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.18),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            /* Subtle paper texture effect */
            background-image:
                linear-gradient(145deg, rgba(245, 240, 235, 0.97) 0%, rgba(235, 226, 214, 0.97) 100%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%' height='100%' filter='url(%23noise)'/%3E%3C/svg%3E");
            background-blend-mode: normal, soft-light;
        }

        .auth-title {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-weight: 500;
            margin: 0 0 0.5rem 0;
            text-align: center;
            color: var(--color-text);
        }

        .auth-subtitle {
            font-size: 0.9375rem;
            color: var(--color-text-secondary);
            text-align: center;
            margin: 0 0 1.75rem 0;
            line-height: 1.6;
        }

        .auth-action-title {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-weight: 500;
            margin: 0.25rem 0 0.75rem 0;
            text-align: center;
            color: var(--color-text);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .form-group label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-text-muted);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            font-family: var(--font-sans);
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--color-gold);
        }

        .btn {
            display: inline-block;
            padding: 0.875rem 1.5rem;
            font-family: var(--font-sans);
            font-size: 0.9375rem;
            font-weight: 500;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .btn--primary {
            background: var(--color-terracotta);
            color: white;
        }

        .btn--primary:hover {
            background: var(--color-terracotta-dark);
        }

        .btn--primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .auth-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--color-terracotta);
            cursor: pointer;
            font-size: 0.875rem;
            text-decoration: underline;
            padding: 0;
        }

        .btn-link:hover {
            color: var(--color-terracotta-dark);
        }

        .auth-error {
            padding: 0.75rem;
            background: #FDEAEA;
            border: 1px solid var(--color-error);
            border-radius: 4px;
            color: var(--color-error);
            font-size: 0.875rem;
            text-align: center;
        }

        .auth-success {
            padding: 0.75rem;
            background: #EAF5EE;
            border: 1px solid var(--color-success);
            border-radius: 4px;
            color: var(--color-success);
            font-size: 0.875rem;
            text-align: center;
        }

        .auth-credit {
            position: absolute;
            bottom: 24px;
            right: 24px;
            font-size: 0.6875rem;
            color: rgba(45, 41, 38, 0.6);
            z-index: 5;
            text-align: right;
            line-height: 1.4;
        }

        .back-link {
            position: absolute;
            top: 24px;
            left: 24px;
            font-size: 0.8125rem;
            color: var(--color-text-secondary);
            text-decoration: none;
            z-index: 15;
        }

        .back-link:hover {
            color: var(--color-text);
        }

        .forgot-password {
            text-align: center;
            margin-top: 1rem;
        }

        .forgot-password .btn-link {
            font-size: 0.8125rem;
            color: var(--color-text-muted);
        }

        .forgot-password .btn-link:hover {
            color: var(--color-terracotta);
        }

        @media (max-width: 540px) {
            .auth-page {
                padding: 8px;
            }

            .auth-page::before {
                inset: 8px;
                border-width: 4px;
            }

            .auth-card {
                padding: 2rem 1.5rem;
                margin: 0 0.5rem;
            }

            .auth-title {
                font-size: 1.75rem;
            }

            .auth-credit {
                bottom: 16px;
                right: 16px;
                left: 16px;
                text-align: center;
            }

            .back-link {
                top: 16px;
                left: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="auth-page">
        <div class="auth-page__bg"></div>
        <div class="auth-page__overlay"></div>

        <a href="/" class="back-link">&larr; Back</a>

        <div class="auth-card">
            <h1 class="auth-title" id="authTitle">Sign In</h1>
            <h3 class="auth-action-title" id="authActionTitle" style="display: none;"></h3>
            <p class="auth-subtitle" id="authSubtitle">Welcome back to your collection</p>

            <div class="auth-error" id="authError" style="display: none;"></div>
            <div class="auth-success" id="authSuccess" style="display: none;"></div>

            <form id="authForm" class="auth-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required minlength="8" autocomplete="current-password">
                </div>

                <div class="form-group" id="confirmGroup" style="display: none;">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" autocomplete="new-password">
                </div>

                <button type="submit" class="btn btn--primary" id="authSubmit">Sign In</button>
            </form>

            <div class="auth-toggle">
                <span id="toggleText">Don't have an account?</span>
                <button type="button" class="btn-link" id="toggleAuth">Sign Up</button>
            </div>

            <div class="forgot-password" id="forgotPasswordSection">
                <button type="button" class="btn-link" id="forgotPasswordBtn">Forgot password?</button>
            </div>
        </div>

        <div class="auth-credit">
            <em>On the Bank of the Seine, Bennecourt</em><br>
            Claude Monet, 1868
        </div>
    </div>

    <script>
    (function() {
        const form = document.getElementById('authForm');
        const title = document.getElementById('authTitle');
        const actionTitle = document.getElementById('authActionTitle');
        const subtitle = document.getElementById('authSubtitle');
        const submit = document.getElementById('authSubmit');
        const toggleBtn = document.getElementById('toggleAuth');
        const toggleText = document.getElementById('toggleText');
        const confirmGroup = document.getElementById('confirmGroup');
        const confirmInput = document.getElementById('confirmPassword');
        const errorDiv = document.getElementById('authError');
        const successDiv = document.getElementById('authSuccess');

        let isSignUp = false;

        const signUpSubtitle = 'Browse, discover, and collect some of the coolest visual art over centuries.<br><br>Create art playlists. Add notes and tags. Share with friends.<br><br>Enjoy :)';

        function setSignUpMode() {
            title.textContent = 'Welcome to Art Stuff';
            actionTitle.textContent = 'Create Account';
            actionTitle.style.display = 'block';
            subtitle.innerHTML = signUpSubtitle;
            submit.textContent = 'Create Account';
            toggleText.textContent = 'Already have an account?';
            toggleBtn.textContent = 'Sign In';
            confirmGroup.style.display = 'block';
            confirmInput.required = true;
        }

        function setSignInMode() {
            title.textContent = 'Sign In';
            actionTitle.style.display = 'none';
            subtitle.innerHTML = 'Welcome back to your collection';
            submit.textContent = 'Sign In';
            toggleText.textContent = "Don't have an account?";
            toggleBtn.textContent = 'Sign Up';
            confirmGroup.style.display = 'none';
            confirmInput.required = false;
        }

        // Check URL params for signup mode
        if (window.location.search.includes('signup')) {
            isSignUp = true;
            setSignUpMode();
        }

        const forgotBtn = document.getElementById('forgotPasswordBtn');
        const forgotSection = document.getElementById('forgotPasswordSection');
        const passwordGroup = document.querySelector('#password').closest('.form-group');
        let isForgotPassword = false;

        toggleBtn.addEventListener('click', () => {
            isSignUp = !isSignUp;
            isForgotPassword = false;
            if (isSignUp) {
                setSignUpMode();
            } else {
                setSignInMode();
            }
            passwordGroup.style.display = 'block';
            document.getElementById('password').required = true;
            forgotSection.style.display = isSignUp ? 'none' : 'block';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
        });

        forgotBtn.addEventListener('click', () => {
            isForgotPassword = true;
            isSignUp = false;
            title.textContent = 'Reset Password';
            subtitle.textContent = 'Enter your email and we\'ll send you a reset link';
            submit.textContent = 'Send Reset Link';
            passwordGroup.style.display = 'none';
            document.getElementById('password').required = false;
            confirmGroup.style.display = 'none';
            confirmInput.required = false;
            forgotSection.innerHTML = '<button type="button" class="btn-link" id="backToSignIn">Back to Sign In</button>';
            document.getElementById('backToSignIn').addEventListener('click', () => {
                isForgotPassword = false;
                setSignInMode();
                passwordGroup.style.display = 'block';
                document.getElementById('password').required = true;
                forgotSection.innerHTML = '<button type="button" class="btn-link" id="forgotPasswordBtn">Forgot password?</button>';
                document.getElementById('forgotPasswordBtn').addEventListener('click', forgotBtn.onclick);
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
            });
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // Handle forgot password
            if (isForgotPassword) {
                submit.disabled = true;
                submit.textContent = 'Sending...';
                try {
                    const response = await fetch('/api/auth/forgot-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const data = await response.json();
                    successDiv.textContent = data.message || 'If an account exists, a reset link has been sent.';
                    successDiv.style.display = 'block';
                } catch (err) {
                    errorDiv.textContent = 'Failed to send reset email. Please try again.';
                    errorDiv.style.display = 'block';
                } finally {
                    submit.disabled = false;
                    submit.textContent = 'Send Reset Link';
                }
                return;
            }

            if (isSignUp) {
                const confirm = document.getElementById('confirmPassword').value;
                if (password !== confirm) {
                    errorDiv.textContent = 'Passwords do not match';
                    errorDiv.style.display = 'block';
                    return;
                }
            }

            submit.disabled = true;
            submit.textContent = isSignUp ? 'Creating...' : 'Signing in...';

            try {
                const endpoint = isSignUp ? '/api/auth/signup' : '/api/auth/login';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.session && data.session.access_token) {
                    // Store token
                    localStorage.setItem('auth_token', data.session.access_token);
                    localStorage.setItem('auth_user', JSON.stringify(data.user));

                    // Redirect to explore (the main app)
                    window.location.href = '/explore';
                } else if (isSignUp) {
                    // Email confirmation may be required
                    successDiv.textContent = 'Account created! Check your email to confirm, then sign in.';
                    successDiv.style.display = 'block';
                    // Switch to sign in mode
                    toggleBtn.click();
                }
            } catch (err) {
                errorDiv.textContent = err.message || 'An error occurred';
                errorDiv.style.display = 'block';
            } finally {
                submit.disabled = false;
                submit.textContent = isSignUp ? 'Create Account' : 'Sign In';
            }
        });

        // Check if already logged in - redirect to app
        const token = localStorage.getItem('auth_token');
        if (token) {
            window.location.href = '/explore';
        }
    })();
    </script>
</body>
</html>
